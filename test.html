<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>챗봇 위젯 테스트 페이지</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --color-primary: #2563eb;
        --color-primary-hover: #1d4ed8;
        --color-text: #0f172a;
        --color-text-secondary: #64748b;
        --color-border: #e2e8f0;
        --color-background: #ffffff;
        --color-surface: #f8fafc;
        --color-success: #10b981;
        --color-warning: #f59e0b;
        --color-error: #ef4444;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: var(--color-surface);
        min-height: 100vh;
        padding: 40px 20px;
        color: var(--color-text);
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: var(--color-background);
        border-radius: 24px;
        box-shadow: var(--shadow-xl);
        overflow: hidden;
        border: 1px solid var(--color-border);
      }

      .header {
        background: var(--color-background);
        border-bottom: 1px solid var(--color-border);
        padding: 48px 40px;
      }

      .header h1 {
        font-size: 32px;
        font-weight: 700;
        color: var(--color-text);
        margin-bottom: 8px;
        letter-spacing: -0.5px;
      }

      .header p {
        font-size: 16px;
        color: var(--color-text-secondary);
        font-weight: 400;
      }

      .content {
        padding: 40px;
      }

      .section {
        margin-bottom: 48px;
      }

      .section:last-child {
        margin-bottom: 0;
      }

      .section h2 {
        font-size: 20px;
        font-weight: 600;
        color: var(--color-text);
        margin-bottom: 20px;
        letter-spacing: -0.3px;
      }

      .preset-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 24px;
      }

      .preset-btn {
        padding: 12px 24px;
        border: 1.5px solid var(--color-border);
        border-radius: 12px;
        background: var(--color-background);
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: var(--color-text);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
      }

      .preset-btn:hover {
        border-color: var(--color-primary);
        color: var(--color-primary);
        background: rgba(37, 99, 235, 0.05);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .preset-btn.active {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
        box-shadow: var(--shadow-md);
      }

      .preset-btn.active:hover {
        background: var(--color-primary-hover);
        border-color: var(--color-primary-hover);
      }

      .color-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }

      .color-input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .color-input-group label {
        font-size: 13px;
        font-weight: 600;
        color: var(--color-text);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .color-input-wrapper {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .color-picker {
        width: 56px;
        height: 48px;
        border: 2px solid var(--color-border);
        border-radius: 12px;
        cursor: pointer;
        flex-shrink: 0;
        transition: all 0.2s;
        overflow: hidden;
      }

      .color-picker:hover {
        border-color: var(--color-primary);
        transform: scale(1.05);
      }

      .color-picker::-webkit-color-swatch-wrapper {
        padding: 0;
      }

      .color-picker::-webkit-color-swatch {
        border: none;
        border-radius: 10px;
      }

      .color-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid var(--color-border);
        border-radius: 12px;
        font-size: 14px;
        font-family: "SF Mono", "Monaco", "Inconsolata", "Fira Code",
          "Courier New", monospace;
        transition: all 0.2s;
        background: var(--color-background);
        color: var(--color-text);
        font-weight: 500;
      }

      .color-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .color-input::placeholder {
        color: var(--color-text-secondary);
        opacity: 0.5;
      }

      .info-box {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-left: 4px solid var(--color-primary);
        padding: 20px;
        border-radius: 12px;
        margin-top: 24px;
      }

      .info-box p {
        font-size: 14px;
        color: var(--color-text-secondary);
        line-height: 1.7;
      }

      .info-box strong {
        color: var(--color-text);
        font-weight: 600;
      }

      .info-box code {
        background: rgba(0, 0, 0, 0.05);
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 13px;
        font-family: "SF Mono", "Monaco", "Inconsolata", "Fira Code",
          "Courier New", monospace;
        color: var(--color-primary);
        font-weight: 600;
      }

      .status-wrapper {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
      }

      .status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
      }

      .status::before {
        content: "";
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
      }

      .status.loading {
        background: rgba(245, 158, 11, 0.1);
        color: var(--color-warning);
      }

      .status.ready {
        background: rgba(16, 185, 129, 0.1);
        color: var(--color-success);
      }

      .status.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--color-error);
      }

      .reload-btn {
        margin-top: 24px;
        padding: 14px 32px;
        background: var(--color-primary);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-md);
        letter-spacing: -0.2px;
      }

      .reload-btn:hover {
        background: var(--color-primary-hover);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .reload-btn:active {
        transform: translateY(0);
        box-shadow: var(--shadow-sm);
      }

      @media (max-width: 768px) {
        body {
          padding: 20px 12px;
        }

        .header {
          padding: 32px 24px;
        }

        .header h1 {
          font-size: 24px;
        }

        .content {
          padding: 24px;
        }

        .section {
          margin-bottom: 32px;
        }

        .color-grid {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .preset-buttons {
          gap: 8px;
        }

        .preset-btn {
          padding: 10px 16px;
          font-size: 13px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>챗봇 위젯 테스트</h1>
        <p>다양한 색상 테마와 설정을 테스트해보세요</p>
      </div>

      <div class="content">
        <div class="section">
          <h2>테마 프리셋</h2>
          <div class="preset-buttons" id="presetButtons"></div>
        </div>

        <div class="section">
          <h2>색상 커스터마이징</h2>
          <div class="color-grid" id="colorGrid"></div>
        </div>

        <div class="section">
          <h2>위젯 상태</h2>
          <div class="status-wrapper">
            <div id="widgetStatus" class="status loading">로딩 중</div>
          </div>
          <div class="info-box">
            <p>
              <strong>사용 방법</strong><br />
              1. 테마 프리셋을 선택하거나 색상을 직접 입력하세요<br />
              2. 색상은 <code>#</code> 없이 6자리 hex 코드로 입력합니다 (예:
              <code>ff4500</code>)<br />
              3. 변경사항을 적용하려면 "위젯 다시 로드" 버튼을 클릭하세요<br />
              4. 화면 우하단에 챗봇 버튼이 표시됩니다
            </p>
          </div>
          <button class="reload-btn" onclick="reloadWidget()">
            위젯 다시 로드
          </button>
        </div>

        <div class="section">
          <h2>이벤트 훅</h2>
          <div class="info-box">
            <p>
              <strong>사용 가능한 이벤트:</strong><br />
              <code>onOpen</code>, <code>onClose</code>, <code>onReady</code>,
              <code>onMessage</code>, <code>onMessageSent</code>,
              <code>onMessageReceived</code>
            </p>
            <p style="margin-top: 12px;">
              <strong>사용 예제:</strong>
            </p>
            <pre
              style="
                background: rgba(0, 0, 0, 0.05);
                padding: 12px;
                border-radius: 8px;
                font-size: 12px;
                margin-top: 8px;
                overflow-x: auto;
                font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
              "
            ><code>// 이벤트 핸들러 등록
ChatbotWidget.on('onOpen', (data) => {
  console.log('위젯 열림:', data);
});

ChatbotWidget.on('onMessage', (data) => {
  console.log('메시지:', data);
});

// CustomEvent로도 사용 가능
window.addEventListener('chatbot:onOpen', (e) => {
  console.log('위젯 열림:', e.detail);
});</code></pre>
          </div>
          <div id="eventLog" style="margin-top: 16px;">
            <p style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--color-text);">
              이벤트 로그:
            </p>
            <div
              id="eventLogContent"
              style="
                background: var(--color-surface);
                border: 1px solid var(--color-border);
                border-radius: 8px;
                padding: 12px;
                max-height: 200px;
                overflow-y: auto;
                font-size: 12px;
                font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
              "
            >
              <div style="color: var(--color-text-secondary);">
                이벤트가 발생하면 여기에 표시됩니다...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 개발 환경 설정
      const WIDGET_ORIGIN = "http://localhost:5173";
      const LOADER_URL = `${WIDGET_ORIGIN}/loader.js`;

      // 색상 옵션 정의
      const colorOptions = [
        { key: "primaryColor", label: "주요 색상", default: "ff4500" },
        { key: "buttonColor", label: "버튼 색상", default: "ff4500" },
        { key: "backgroundColor", label: "배경색", default: "ffffff" },
        { key: "textColor", label: "텍스트 색상", default: "1e293b" },
        {
          key: "textSecondaryColor",
          label: "보조 텍스트",
          default: "64748b",
        },
        { key: "borderColor", label: "테두리 색상", default: "e2e8f0" },
        {
          key: "userMessageBg",
          label: "사용자 메시지 배경",
          default: "ff4500",
        },
        {
          key: "assistantMessageBg",
          label: "어시스턴트 메시지 배경",
          default: "ffffff",
        },
      ];

      // 테마 프리셋
      const presets = {
        default: {
          name: "기본 (오렌지)",
          colors: {
            primaryColor: "ff4500",
            buttonColor: "ff4500",
            userMessageBg: "ff4500",
          },
        },
        blue: {
          name: "블루",
          colors: {
            primaryColor: "3b82f6",
            buttonColor: "2563eb",
            userMessageBg: "3b82f6",
          },
        },
        green: {
          name: "그린",
          colors: {
            primaryColor: "10b981",
            buttonColor: "059669",
            userMessageBg: "10b981",
          },
        },
        purple: {
          name: "퍼플",
          colors: {
            primaryColor: "8b5cf6",
            buttonColor: "7c3aed",
            userMessageBg: "8b5cf6",
          },
        },
        pink: {
          name: "핑크",
          colors: {
            primaryColor: "ec4899",
            buttonColor: "db2777",
            userMessageBg: "ec4899",
          },
        },
        dark: {
          name: "다크",
          colors: {
            primaryColor: "1e293b",
            buttonColor: "0f172a",
            backgroundColor: "1e293b",
            textColor: "f1f5f9",
            textSecondaryColor: "cbd5e1",
            borderColor: "334155",
            userMessageBg: "475569",
            assistantMessageBg: "334155",
          },
        },
      };

      let currentColors = {};
      let currentPreset = null;
      let widgetScript = null;

      // 색상 입력 필드 생성
      function createColorInputs() {
        const grid = document.getElementById("colorGrid");
        grid.innerHTML = "";

        colorOptions.forEach((option) => {
          const group = document.createElement("div");
          group.className = "color-input-group";

          const label = document.createElement("label");
          label.textContent = option.label;
          label.setAttribute("for", option.key);

          const wrapper = document.createElement("div");
          wrapper.className = "color-input-wrapper";

          const picker = document.createElement("input");
          picker.type = "color";
          picker.className = "color-picker";
          picker.value = `#${currentColors[option.key] || option.default}`;
          picker.addEventListener("change", (e) => {
            const hex = e.target.value.replace("#", "");
            document.getElementById(option.key).value = hex;
            currentColors[option.key] = hex;
            currentPreset = null;
            updatePresetButtons();
          });

          const input = document.createElement("input");
          input.type = "text";
          input.id = option.key;
          input.className = "color-input";
          input.value = currentColors[option.key] || option.default;
          input.placeholder = option.default;
          input.pattern = "[0-9A-Fa-f]{6}";
          input.addEventListener("input", (e) => {
            const value = e.target.value.replace("#", "").toUpperCase();
            if (/^[0-9A-Fa-f]{0,6}$/.test(value)) {
              e.target.value = value;
              currentColors[option.key] = value;
              picker.value = `#${value || option.default}`;
              currentPreset = null;
              updatePresetButtons();
            }
          });

          wrapper.appendChild(picker);
          wrapper.appendChild(input);
          group.appendChild(label);
          group.appendChild(wrapper);
          grid.appendChild(group);
        });
      }

      // 프리셋 버튼 생성
      function createPresetButtons() {
        const container = document.getElementById("presetButtons");
        container.innerHTML = "";

        Object.entries(presets).forEach(([key, preset]) => {
          const btn = document.createElement("button");
          btn.className = "preset-btn";
          btn.textContent = preset.name;
          btn.addEventListener("click", () => applyPreset(key));
          container.appendChild(btn);
        });

        updatePresetButtons();
      }

      // 프리셋 적용
      function applyPreset(presetKey) {
        const preset = presets[presetKey];
        currentPreset = presetKey;

        // 기본 색상으로 초기화
        colorOptions.forEach((option) => {
          currentColors[option.key] = option.default;
        });

        // 프리셋 색상 적용
        Object.assign(currentColors, preset.colors);

        // UI 업데이트
        createColorInputs();
        updatePresetButtons();
      }

      // 프리셋 버튼 상태 업데이트
      function updatePresetButtons() {
        const buttons = document.querySelectorAll(".preset-btn");
        buttons.forEach((btn, index) => {
          const presetKey = Object.keys(presets)[index];
          if (presetKey === currentPreset) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });
      }

      // camelCase를 kebab-case로 변환 (예: primaryColor -> primary-color)
      function camelToKebab(str) {
        return str.replace(/([A-Z])/g, "-$1").toLowerCase();
      }

      // 위젯 요소 제거
      function removeWidget() {
        // 기존 스크립트 제거
        if (widgetScript) {
          widgetScript.remove();
          widgetScript = null;
        }

        // loader.js가 생성한 모든 요소 제거
        // 1. 런처 버튼 (aria-label로 찾기)
        const launcherBtn = document.querySelector(
          'button[aria-label="챗봇 열기"]'
        );
        if (launcherBtn) {
          launcherBtn.remove();
        }

        // 2. iframe을 포함한 wrap 찾기 (iframe의 title로 찾기)
        const iframe = document.querySelector('iframe[title="Chatbot"]');
        if (iframe && iframe.parentElement) {
          iframe.parentElement.remove();
        }

        // 3. overlay 찾기 (높은 z-index와 fixed position으로 찾기)
        // loader.js의 Z 값은 2147483647
        const allElements = Array.from(document.querySelectorAll("*"));
        allElements.forEach((el) => {
          if (el === document.body || el === document.documentElement) return;

          const style = window.getComputedStyle(el);
          const zIndex = parseInt(style.zIndex) || 0;

          // 높은 z-index를 가진 fixed 요소 찾기
          if (zIndex >= 2147483640 && style.position === "fixed") {
            // overlay: 전체 화면을 덮는 요소 (inset: 0)
            const isOverlay =
              (style.top === "0px" || style.top === "") &&
              (style.right === "0px" || style.right === "") &&
              (style.bottom === "0px" || style.bottom === "") &&
              (style.left === "0px" || style.left === "");

            // wrap: iframe을 포함하거나 특정 위치에 있는 요소
            const hasIframe = el.querySelector('iframe[title="Chatbot"]');
            const isButton = el.getAttribute("aria-label") === "챗봇 열기";

            if (isOverlay || hasIframe || isButton) {
              el.remove();
            }
          }
        });
      }

      // 위젯 로드
      function loadWidget() {
        // 기존 위젯 완전히 제거
        removeWidget();

        // 잠시 대기 후 새 스크립트 로드 (DOM 정리 시간 확보)
        setTimeout(() => {
          // 새 스크립트 생성 (캐시 방지를 위해 timestamp 추가)
          widgetScript = document.createElement("script");
          widgetScript.src = `${LOADER_URL}?t=${Date.now()}`;
          widgetScript.setAttribute("data-widget-key", "test-key");

          // 색상 옵션 적용 (스크립트가 로드되기 전에 설정)
          // HTML data-* 속성은 kebab-case를 사용해야 함 (primaryColor -> primary-color)
          Object.entries(currentColors).forEach(([key, value]) => {
            if (value) {
              const kebabKey = camelToKebab(key);
              widgetScript.setAttribute(`data-${kebabKey}`, value);
              console.log(`색상 속성 설정: data-${kebabKey} = ${value}`);
            }
          });

          // 상태 업데이트
          const status = document.getElementById("widgetStatus");
          status.className = "status loading";
          status.textContent = "위젯 로딩 중...";

          // 스크립트 로드 이벤트
          widgetScript.onload = () => {
            // 위젯이 준비될 때까지 약간 대기
            setTimeout(() => {
              // 초기 색상 정보 전달 (WM_INIT에서 이미 전달되지만, 확실하게 하기 위해)
              updateWidgetColors();

              status.className = "status ready";
              status.textContent = "위젯 준비 완료";
            }, 800);
          };

          widgetScript.onerror = () => {
            status.className = "status error";
            status.textContent =
              "위젯 로드 실패. 개발 서버가 실행 중인지 확인하세요.";
          };

          document.body.appendChild(widgetScript);
        }, 150);
      }

      // 색상 정보를 loader.js에 전달
      function updateWidgetColors() {
        const colorData = {
          primary: currentColors.primaryColor || "ff4500",
          button:
            currentColors.buttonColor || currentColors.primaryColor || "ff4500",
          background: currentColors.backgroundColor || "ffffff",
          text: currentColors.textColor || "1e293b",
          textSecondary: currentColors.textSecondaryColor || "64748b",
          border: currentColors.borderColor || "e2e8f0",
          userMessageBg:
            currentColors.userMessageBg ||
            currentColors.primaryColor ||
            "ff4500",
          assistantMessageBg: currentColors.assistantMessageBg || "ffffff",
        };

        console.log("색상 데이터 전송:", colorData);
        console.log("현재 색상 상태:", currentColors);

        // loader.js의 전역 함수 호출
        if (typeof window.updateWidgetColors === "function") {
          window.updateWidgetColors(colorData);
          return true;
        } else {
          console.warn("loader.js가 아직 로드되지 않았습니다.");
          return false;
        }
      }

      // 위젯 다시 로드
      function reloadWidget() {
        console.log("위젯 다시 로드 시작, currentColors:", currentColors);

        // 항상 loader.js를 다시 불러오기 (색상 변경을 확실하게 반영)
        removeWidget();

        // 잠시 대기 후 새 스크립트 로드
        setTimeout(() => {
          // 새 스크립트 생성 (캐시 방지를 위해 timestamp 추가)
          widgetScript = document.createElement("script");
          widgetScript.src = `${LOADER_URL}?t=${Date.now()}`;
          widgetScript.setAttribute("data-widget-key", "test-key");

          // 색상 옵션 적용 (스크립트가 로드되기 전에 설정)
          // HTML data-* 속성은 kebab-case를 사용해야 함 (primaryColor -> primary-color)
          Object.entries(currentColors).forEach(([key, value]) => {
            if (value) {
              const kebabKey = camelToKebab(key);
              widgetScript.setAttribute(`data-${kebabKey}`, value);
              console.log(`색상 속성 설정: data-${kebabKey} = ${value}`);
            }
          });

          // 상태 업데이트
          const status = document.getElementById("widgetStatus");
          status.className = "status loading";
          status.textContent = "위젯 로딩 중...";

          // 스크립트 로드 이벤트
          widgetScript.onload = () => {
            setTimeout(() => {
              status.className = "status ready";
              status.textContent = "위젯 준비 완료";
            }, 800);
          };

          widgetScript.onerror = () => {
            status.className = "status error";
            status.textContent =
              "위젯 로드 실패. 개발 서버가 실행 중인지 확인하세요.";
          };

          document.body.appendChild(widgetScript);
        }, 150);
      }

      // 초기화
      function init() {
        // 기본 프리셋 적용
        applyPreset("default");
        createPresetButtons();

        // 위젯 로드
        loadWidget();
      }

      // 페이지 로드 시 초기화
      window.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
